#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "$0")/.." && pwd)"
ASHIGARU_COUNT=7
SHOGUN_SESSION="shogun"
MULTIAGENT_SESSION="multiagent"
COMM_MODE="${SHOGUN_COMM_MODE:-teams}"
START_WATCHERS=0
AUTOPILOT="${SHOGUN_AUTOPILOT:-1}"
AGENT_INTERVAL="${SHOGUN_AGENT_INTERVAL:-2}"
LEADER_WATCH="${SHOGUN_LEADER_WATCH:-1}"
SHOW_FEED="${SHOGUN_SHOW_FEED:-1}"
FEED_TAIL_EVENTS="${SHOGUN_FEED_TAIL_EVENTS:-0}"
FEED_TAIL_MESSAGES="${SHOGUN_FEED_TAIL_MESSAGES:-0}"
FEED_INTERVAL="${SHOGUN_FEED_INTERVAL:-1}"
FEED_TRUNCATE="${SHOGUN_FEED_TRUNCATE:-0}"
DRAMA_MODE="${SHOGUN_DRAMA_MODE:-1}"
SKILL_AUTOPILOT="${SHOGUN_SKILL_AUTOPILOT:-1}"
SKILL_INTERVAL_SEC="${SHOGUN_SKILL_INTERVAL_SEC:-30}"
SKILL_MIN_COUNT="${SHOGUN_SKILL_MIN_COUNT:-3}"
SKILL_SENDER="${SHOGUN_SKILL_SENDER:-skillsmith}"
KARO_DECOMPOSE_MODE="${SHOGUN_KARO_DECOMPOSE_MODE:-auto}"
ASHIGARU_EXEC_MODE="${SHOGUN_ASHIGARU_EXEC_MODE:-auto}"
KARO_CODEX_BIN="${SHOGUN_KARO_CODEX_BIN:-codex}"
ASHIGARU_CODEX_BIN="${SHOGUN_ASHIGARU_CODEX_BIN:-codex}"
DIALOGUE_MODE="${SHOGUN_DIALOGUE_MODE:-auto}"
DIALOGUE_CODEX_BIN="${SHOGUN_DIALOGUE_CODEX_BIN:-codex}"
SAMURAI_TONE="${SHOGUN_SAMURAI_TONE:-strong}"
ASHIGARU_ACK_WAIT_SEC="${SHOGUN_ASHIGARU_ACK_WAIT_SEC:-8}"
ASHIGARU_PROGRESS_INTERVAL_SEC="${SHOGUN_ASHIGARU_PROGRESS_INTERVAL_SEC:-10}"

usage() {
  cat <<'EOF'
Usage: bin/shogun-launch [--ashigaru N] [--shogun-session NAME] [--multiagent-session NAME] [--comm-mode MODE] [--watch]
                        [--autopilot|--no-autopilot] [--agent-interval SEC]
                        [--skills|--no-skills] [--skill-interval-sec SEC] [--skill-min-count N] [--skill-sender NAME]
                        [--karo-decompose-mode MODE] [--ashigaru-exec-mode MODE]
                        [--dialogue-mode MODE] [--samurai-tone LEVEL]
                        [--ashigaru-ack-wait-sec SEC] [--ashigaru-progress-interval-sec SEC]
                        [--drama|--no-drama]
                        [--leader-watch|--no-leader-watch]
                        [--feed|--no-feed] [--feed-tail-events N] [--feed-tail-messages N]
                        [--feed-interval SEC] [--feed-truncate N]

Environment:
  SHOGUN_AGENT_BOOT_CMD  Optional command executed in each agent pane after setup.
  SHOGUN_DRAMA_MODE      1 enables samurai/drama chatter (default: 1)
EOF
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    --ashigaru)
      ASHIGARU_COUNT="$2"
      shift 2
      ;;
    --shogun-session)
      SHOGUN_SESSION="$2"
      shift 2
      ;;
    --multiagent-session)
      MULTIAGENT_SESSION="$2"
      shift 2
      ;;
    --comm-mode)
      COMM_MODE="$2"
      shift 2
      ;;
    --watch)
      START_WATCHERS=1
      shift
      ;;
    --autopilot)
      AUTOPILOT=1
      shift
      ;;
    --no-autopilot)
      AUTOPILOT=0
      shift
      ;;
    --agent-interval)
      AGENT_INTERVAL="$2"
      shift 2
      ;;
    --skills)
      SKILL_AUTOPILOT=1
      shift
      ;;
    --no-skills)
      SKILL_AUTOPILOT=0
      shift
      ;;
    --skill-interval-sec)
      SKILL_INTERVAL_SEC="$2"
      shift 2
      ;;
    --skill-min-count)
      SKILL_MIN_COUNT="$2"
      shift 2
      ;;
    --skill-sender)
      SKILL_SENDER="$2"
      shift 2
      ;;
    --karo-decompose-mode)
      KARO_DECOMPOSE_MODE="$2"
      shift 2
      ;;
    --ashigaru-exec-mode)
      ASHIGARU_EXEC_MODE="$2"
      shift 2
      ;;
    --dialogue-mode)
      DIALOGUE_MODE="$2"
      shift 2
      ;;
    --samurai-tone)
      SAMURAI_TONE="$2"
      shift 2
      ;;
    --ashigaru-ack-wait-sec)
      ASHIGARU_ACK_WAIT_SEC="$2"
      shift 2
      ;;
    --ashigaru-progress-interval-sec)
      ASHIGARU_PROGRESS_INTERVAL_SEC="$2"
      shift 2
      ;;
    --drama)
      DRAMA_MODE=1
      shift
      ;;
    --no-drama)
      DRAMA_MODE=0
      shift
      ;;
    --leader-watch)
      LEADER_WATCH=1
      shift
      ;;
    --no-leader-watch)
      LEADER_WATCH=0
      shift
      ;;
    --feed)
      SHOW_FEED=1
      shift
      ;;
    --no-feed)
      SHOW_FEED=0
      shift
      ;;
    --feed-tail-events)
      FEED_TAIL_EVENTS="$2"
      shift 2
      ;;
    --feed-tail-messages)
      FEED_TAIL_MESSAGES="$2"
      shift 2
      ;;
    --feed-interval)
      FEED_INTERVAL="$2"
      shift 2
      ;;
    --feed-truncate)
      FEED_TRUNCATE="$2"
      shift 2
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    *)
      echo "unknown option: $1" >&2
      usage
      exit 1
      ;;
  esac
done

if ! command -v tmux >/dev/null 2>&1; then
  echo "error: tmux is required" >&2
  exit 1
fi

"$ROOT_DIR/bin/shogunctl" init >/dev/null
"$ROOT_DIR/bin/shogunctl" reset >/dev/null
"$ROOT_DIR/bin/shogunctl" seed-team --ashigaru "$ASHIGARU_COUNT" --reset >/dev/null
"$ROOT_DIR/bin/shogun-comm" --mode "$COMM_MODE" init >/dev/null

if tmux has-session -t "$SHOGUN_SESSION" 2>/dev/null; then
  echo "error: tmux session '$SHOGUN_SESSION' already exists" >&2
  exit 1
fi
if tmux has-session -t "$MULTIAGENT_SESSION" 2>/dev/null; then
  echo "error: tmux session '$MULTIAGENT_SESSION' already exists" >&2
  exit 1
fi

tmux new-session -d -s "$SHOGUN_SESSION" -n lead
SHOGUN_WATCH_CMD=""
if [[ "$LEADER_WATCH" -eq 1 ]]; then
  SHOGUN_WATCH_CMD="bin/shogun-mailbox-watch --name shogun --mode \"$COMM_MODE\" --interval-sec 2 &"
fi
SKILL_DAEMON_CMD=""
if [[ "$SKILL_AUTOPILOT" -eq 1 ]]; then
  SKILL_DAEMON_CMD="./bin/shogun-skillflow --mode \"$COMM_MODE\" --sender \"$SKILL_SENDER\" scan --loop --interval-sec \"$SKILL_INTERVAL_SEC\" --min-count \"$SKILL_MIN_COUNT\" >/tmp/shogun-skillflow.log 2>&1 &"
fi
tmux send-keys -t "${SHOGUN_SESSION}:0.0" \
  "cd \"$ROOT_DIR\"; export SHOGUN_NAME=shogun SHOGUN_ROLE=shogun SHOGUN_COMM_MODE=\"$COMM_MODE\" SHOGUN_DRAMA_MODE=\"$DRAMA_MODE\"; clear; echo '[将軍] ここは軍議所。委任専任にて動く。'; echo '使い方: bin/shogun-remote run \"<command>\"'; echo \"comm mode: $COMM_MODE\"; echo \"drama mode: $DRAMA_MODE\"; echo \"skill autopilot: $SKILL_AUTOPILOT\"; bin/shogunctl member set-status --name shogun --status working --session \"$SHOGUN_SESSION\" --pane 0 >/dev/null; ${SHOGUN_WATCH_CMD}${SKILL_DAEMON_CMD} echo '[将軍] 下知を待つ。'" C-m

if [[ "$SHOW_FEED" -eq 1 ]]; then
  tmux split-window -t "${SHOGUN_SESSION}:0.0" -v -p 45
  tmux send-keys -t "${SHOGUN_SESSION}:0.1" \
    "cd \"$ROOT_DIR\"; clear; echo '[軍議録] 全隊のやり取りを常時表示'; exec bin/shogun-feed --tail-events \"$FEED_TAIL_EVENTS\" --tail-messages \"$FEED_TAIL_MESSAGES\" --truncate \"$FEED_TRUNCATE\" --interval-sec \"$FEED_INTERVAL\"" C-m
  tmux select-pane -t "${SHOGUN_SESSION}:0.0"
fi

tmux new-session -d -s "$MULTIAGENT_SESSION" -n team
TOTAL_PANES=$((ASHIGARU_COUNT + 2))
for ((i=1; i<TOTAL_PANES; i++)); do
  tmux split-window -t "${MULTIAGENT_SESSION}:0" -d
  tmux select-layout -t "${MULTIAGENT_SESSION}:0" tiled >/dev/null
done
tmux set-environment -t "${MULTIAGENT_SESSION}" SHOGUN_COMM_MODE "$COMM_MODE"
tmux set-environment -t "${MULTIAGENT_SESSION}" SHOGUN_DRAMA_MODE "$DRAMA_MODE"
tmux set-environment -t "${MULTIAGENT_SESSION}" SHOGUN_DIALOGUE_MODE "$DIALOGUE_MODE"
tmux set-environment -t "${MULTIAGENT_SESSION}" SHOGUN_DIALOGUE_CODEX_BIN "$DIALOGUE_CODEX_BIN"
tmux set-environment -t "${MULTIAGENT_SESSION}" SHOGUN_SAMURAI_TONE "$SAMURAI_TONE"
tmux set-environment -t "${MULTIAGENT_SESSION}" SHOGUN_KARO_DECOMPOSE_MODE "$KARO_DECOMPOSE_MODE"
tmux set-environment -t "${MULTIAGENT_SESSION}" SHOGUN_KARO_CODEX_BIN "$KARO_CODEX_BIN"
tmux set-environment -t "${MULTIAGENT_SESSION}" SHOGUN_ASHIGARU_EXEC_MODE "$ASHIGARU_EXEC_MODE"
tmux set-environment -t "${MULTIAGENT_SESSION}" SHOGUN_ASHIGARU_CODEX_BIN "$ASHIGARU_CODEX_BIN"
tmux set-environment -t "${MULTIAGENT_SESSION}" SHOGUN_ASHIGARU_ACK_WAIT_SEC "$ASHIGARU_ACK_WAIT_SEC"
tmux set-environment -t "${MULTIAGENT_SESSION}" SHOGUN_ASHIGARU_PROGRESS_INTERVAL_SEC "$ASHIGARU_PROGRESS_INTERVAL_SEC"

PANE_INDICES=($(tmux list-panes -t "${MULTIAGENT_SESSION}:0" -F '#{pane_index}' | sort -n))
NAMES=("karo" "metsuke")
ROLES=("karo" "metsuke")
for ((i=1; i<=ASHIGARU_COUNT; i++)); do
  NAMES+=("ashigaru${i}")
  ROLES+=("ashigaru")
done

for idx in "${!NAMES[@]}"; do
  pane="${PANE_INDICES[$idx]}"
  name="${NAMES[$idx]}"
  role="${ROLES[$idx]}"
  WATCH_CMD=""
  if [[ "$START_WATCHERS" -eq 1 ]]; then
    WATCH_CMD="bin/shogun-mailbox-watch --name \"$name\" --mode \"$COMM_MODE\" --interval-sec 2 >/tmp/shogun-watch-$name.log 2>&1 & "
  fi
  if [[ "$AUTOPILOT" -eq 1 ]]; then
    tmux send-keys -t "${MULTIAGENT_SESSION}:0.${pane}" \
      "cd \"$ROOT_DIR\"; export SHOGUN_NAME=\"$name\" SHOGUN_ROLE=\"$role\"; clear; echo \"[$name/$role] 出陣準備よし\"; echo \"instruction: instructions/$role.md\"; echo \"comm mode: $COMM_MODE\"; echo \"drama mode: $DRAMA_MODE\"; echo \"karo decompose: $KARO_DECOMPOSE_MODE\"; echo \"ashigaru exec: $ASHIGARU_EXEC_MODE\"; echo \"dialogue mode: $DIALOGUE_MODE\"; echo \"samurai tone: $SAMURAI_TONE\"; echo \"ack wait sec: $ASHIGARU_ACK_WAIT_SEC\"; echo \"progress interval sec: $ASHIGARU_PROGRESS_INTERVAL_SEC\"; bin/shogunctl member set-status --name \"$name\" --status idle --session \"$MULTIAGENT_SESSION\" --pane \"$pane\" >/dev/null; ${WATCH_CMD}if [[ -n \"\${SHOGUN_AGENT_BOOT_CMD:-}\" ]]; then eval \"\$SHOGUN_AGENT_BOOT_CMD\"; fi; echo \"[$name/$role] 自動運用を開始する\"; exec bin/shogun-agent --name \"$name\" --role \"$role\" --interval-sec \"$AGENT_INTERVAL\"" C-m
  else
    tmux send-keys -t "${MULTIAGENT_SESSION}:0.${pane}" \
      "cd \"$ROOT_DIR\"; export SHOGUN_NAME=\"$name\" SHOGUN_ROLE=\"$role\"; clear; echo \"[$name/$role] ready\"; echo \"instruction: instructions/$role.md\"; echo \"comm mode: $COMM_MODE\"; echo \"drama mode: $DRAMA_MODE\"; bin/shogunctl member set-status --name \"$name\" --status idle --session \"$MULTIAGENT_SESSION\" --pane \"$pane\" >/dev/null; ${WATCH_CMD}if [[ -n \"\${SHOGUN_AGENT_BOOT_CMD:-}\" ]]; then eval \"\$SHOGUN_AGENT_BOOT_CMD\"; fi" C-m
  fi
done

echo "sessions created:"
echo "  - $SHOGUN_SESSION (leader)"
echo "  - $MULTIAGENT_SESSION (karo/metsuke/ashigaru*)"
echo "comm mode: $COMM_MODE"
if [[ "$AUTOPILOT" -eq 1 ]]; then
  echo "autopilot: enabled (bin/shogun-agent interval=${AGENT_INTERVAL}s)"
else
  echo "autopilot: disabled"
fi
if [[ "$LEADER_WATCH" -eq 1 ]]; then
  echo "leader watch: enabled (shogun inbox stream)"
else
  echo "leader watch: disabled"
fi
if [[ "$SHOW_FEED" -eq 1 ]]; then
  echo "team feed: enabled (shogun:0.1)"
else
  echo "team feed: disabled"
fi
if [[ "$DRAMA_MODE" -eq 1 ]]; then
  echo "drama mode: enabled (warrior chatter/persona/rules)"
else
  echo "drama mode: disabled"
fi
echo "karo decomposition: $KARO_DECOMPOSE_MODE"
echo "ashigaru execution: $ASHIGARU_EXEC_MODE"
echo "dialogue mode: $DIALOGUE_MODE"
echo "samurai tone: $SAMURAI_TONE"
echo "ashigaru ack wait sec: $ASHIGARU_ACK_WAIT_SEC"
echo "ashigaru progress interval sec: $ASHIGARU_PROGRESS_INTERVAL_SEC"
if [[ "$SKILL_AUTOPILOT" -eq 1 ]]; then
  echo "skill autopilot: enabled (interval=${SKILL_INTERVAL_SEC}s min-count=${SKILL_MIN_COUNT} sender=${SKILL_SENDER})"
else
  echo "skill autopilot: disabled"
fi
if [[ "$START_WATCHERS" -eq 1 ]]; then
  echo "watchers: enabled (logs in /tmp/shogun-watch-*.log)"
fi
echo
echo "attach:"
echo "  tmux attach -t $SHOGUN_SESSION"
echo "  tmux attach -t $MULTIAGENT_SESSION"
