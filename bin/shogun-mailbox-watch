#!/usr/bin/env python3
from __future__ import annotations

import argparse
import json
import os
import subprocess
import time
from pathlib import Path


def root_dir() -> Path:
    return Path(__file__).resolve().parent.parent


def read_inbox(mode: str, name: str, since_id: int | None) -> list[dict[str, object]]:
    cmd = [
        str(root_dir() / "bin" / "shogun-comm"),
        "--mode",
        mode,
        "read",
        "--name",
        name,
        "--json",
        "--limit",
        "200",
    ]
    if since_id is not None:
        cmd.extend(["--since-id", str(since_id)])
    result = subprocess.run(cmd, check=True, capture_output=True, text=True)
    out = result.stdout.strip()
    if not out:
        return []
    try:
        data = json.loads(out)
    except json.JSONDecodeError:
        return []
    if isinstance(data, list):
        return [item for item in data if isinstance(item, dict)]
    return []


def find_max_id(mode: str, items: list[dict[str, object]], current: int) -> int:
    if mode in {"mailbox", "hybrid"}:
        key = "mailbox_seq"
    elif mode == "teams":
        key = "id"
    else:
        return current + len(items)
    max_id = current
    for item in items:
        value = item.get(key)
        if isinstance(value, int) and value > max_id:
            max_id = value
    return max_id


def build_parser() -> argparse.ArgumentParser:
    parser = argparse.ArgumentParser(description="Poll inbox and react to new messages")
    parser.add_argument("--name", required=True)
    parser.add_argument("--mode", default="hybrid", choices=("teams", "mailbox", "hybrid", "ntfy"))
    parser.add_argument("--interval-sec", type=int, default=2)
    parser.add_argument("--start-id", type=int, default=0)
    parser.add_argument("--exec-cmd", help="Run shell command on each new message")
    parser.add_argument("--print-json", action="store_true")
    parser.add_argument("--style", choices=("sengoku", "plain"), default=os.getenv("SHOGUN_SPEECH_STYLE", "sengoku"))
    return parser


def main(argv: list[str] | None = None) -> int:
    args = build_parser().parse_args(argv)
    cursor = args.start_id
    while True:
        try:
            items = read_inbox(args.mode, args.name, cursor if cursor > 0 else None)
        except subprocess.CalledProcessError as exc:
            print(f"watch error: {exc}")
            time.sleep(args.interval_sec)
            continue
        if items:
            for item in items:
                if args.print_json:
                    print(json.dumps(item, ensure_ascii=True))
                else:
                    sender = item.get("sender", "?")
                    content = item.get("content", "")
                    if args.style == "plain":
                        print(f"[{args.name}] from={sender} content={content}")
                    else:
                        print(f"[{args.name}] 早馬着信: {sender}曰く「{content}」")
                if args.exec_cmd:
                    subprocess.run(args.exec_cmd, shell=True, check=False)
            cursor = find_max_id(args.mode, items, cursor)
        time.sleep(args.interval_sec)


if __name__ == "__main__":
    raise SystemExit(main())
